#!/bin/bash

# Improved Uptime Kuma Alert Integration Script
# Monitors Uptime Kuma database and sends accurate email alerts

set -e

# Source the existing email function
source /root/auto-deploy.sh

# Configuration
KUMA_DB="/var/lib/docker/volumes/root_uptime-kuma-data/_data/kuma.db"
ALERT_LOG="/root/uptime-alerts.log"
STATE_FILE="/tmp/uptime-kuma-state"
HEALTH_CHECK_RETRIES=3
HEALTH_CHECK_DELAY=5

log_alert() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $ALERT_LOG
}

# Improved health check with retries
check_service_health() {
    local service=$1
    local url=$2
    local retries=${3:-$HEALTH_CHECK_RETRIES}
    
    for i in $(seq 1 $retries); do
        if curl -s -f -o /dev/null -m 5 "$url" 2>/dev/null; then
            echo "‚úÖ Online"
            return 0
        fi
        [ $i -lt $retries ] && sleep $HEALTH_CHECK_DELAY
    done
    echo "‚ùå Offline"
    return 1
}

# Get detailed system status
get_system_status() {
    local backend_health=$(check_service_health "Backend" "https://localhost/api/health")
    local frontend_health=$(check_service_health "Frontend" "http://localhost:80")
    local dashboard_health=$(check_service_health "Dashboard" "https://dashboard.thermalog.com.au")
    local mqtt_health=$(check_service_health "MQTT Broker" "http://localhost:1883" 1)
    local provisioning_health=$(check_service_health "Provisioning" "http://localhost:3003/health")
    local uptime_health=$(check_service_health "Uptime Kuma" "http://localhost:3002")
    
    # Get container info - include ALL containers
    local container_status=$(docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -E 'thermalog|nginx|mqtt|provisioning|uptime' || echo "No containers found")
    
    # Check database connection using prisma
    local db_status="Unknown"
    if docker exec thermalog-backend sh -c "npx prisma db execute --stdin --schema=/app/prisma/schema/schema.prisma <<< 'SELECT 1'" 2>/dev/null | grep -q "1"; then
        db_status="‚úÖ Connected"
    else
        db_status="‚ùå Disconnected"
    fi
    
    echo "
üè• SYSTEM HEALTH REPORT:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Service Status:
‚Ä¢ Backend API: $backend_health
‚Ä¢ Frontend: $frontend_health
‚Ä¢ Dashboard: $dashboard_health
‚Ä¢ Database: $db_status
‚Ä¢ MQTT Broker: $mqtt_health
‚Ä¢ Provisioning Service: $provisioning_health
‚Ä¢ Uptime Kuma: $uptime_health

üê≥ Container Status:
$container_status

üíæ System Resources:
$(df -h / | tail -1 | awk '{print "‚Ä¢ Disk Usage: "$3"/"$2" ("$5")"}')
$(free -h | grep Mem | awk '{print "‚Ä¢ Memory: "$3"/"$2}')
$(uptime | awk -F'load average:' '{print "‚Ä¢ Load Average:"$2}')
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
}

# Check if Uptime Kuma container is running
if ! docker ps | grep -q uptime-kuma; then
    log_alert "‚ùå Uptime Kuma container is not running"
    exit 1
fi

# Get current monitor status
CURRENT_STATUS=$(docker exec uptime-kuma sqlite3 /app/data/kuma.db "
SELECT m.id, m.name, m.type, 
       CASE 
         WHEN h.status = 0 THEN 'DOWN'
         WHEN h.status = 1 THEN 'UP' 
         WHEN h.status = 2 THEN 'PENDING'
         ELSE 'UNKNOWN'
       END as status,
       h.msg, h.time
FROM monitor m 
LEFT JOIN heartbeat h ON m.id = h.monitor_id 
WHERE h.time = (SELECT MAX(time) FROM heartbeat WHERE monitor_id = m.id)
ORDER BY m.id;
" 2>/dev/null)

# Create current state file
echo "$CURRENT_STATUS" > "${STATE_FILE}.new"

# Check if this is first run
if [ ! -f "$STATE_FILE" ]; then
    log_alert "üîÑ First run - initializing monitor state tracking"
    mv "${STATE_FILE}.new" "$STATE_FILE"
    exit 0
fi

# Compare with previous state
if ! diff -q "$STATE_FILE" "${STATE_FILE}.new" >/dev/null 2>&1; then
    log_alert "üìä Monitor status changes detected"
    
    # Find changes
    while IFS='|' read -r id name type status msg time; do
        # Get previous status for this monitor
        PREV_STATUS=$(grep "^$id|" "$STATE_FILE" 2>/dev/null | cut -d'|' -f4 || echo "UNKNOWN")
        
        if [ "$status" != "$PREV_STATUS" ] && [ "$PREV_STATUS" != "UNKNOWN" ]; then
            
            # For recovery alerts, wait for services to fully initialize
            if [ "$status" = "UP" ] && [ "$PREV_STATUS" = "DOWN" ]; then
                log_alert "‚è≥ Waiting for services to fully initialize before sending recovery alert..."
                sleep 10
            fi
            
            # Get detailed system status
            SYSTEM_STATUS=$(get_system_status)
            
            # Determine alert type and create appropriate message
            case "$status" in
                "DOWN")
                    EMOJI="üö®"
                    PRIORITY="high"
                    ACTION="FAILURE DETECTED"
                    COLOR="#FF0000"
                    ALERT_TYPE="‚ö†Ô∏è SERVICE DOWN ALERT ‚ö†Ô∏è"
                    RECOMMENDATION="
üîß RECOMMENDED ACTIONS:
1. Check container logs: docker logs thermalog-backend
2. Verify database connection: docker exec thermalog-backend npm run db:check
3. Check system resources: df -h && free -h
4. Review recent deployments: git log --oneline -5"
                    ;;
                "UP")
                    EMOJI="‚úÖ"
                    PRIORITY="normal"
                    ACTION="SERVICE RECOVERED"
                    COLOR="#00FF00"
                    ALERT_TYPE="üéâ RECOVERY NOTIFICATION üéâ"
                    RECOMMENDATION="
‚ú® RECOVERY CONFIRMED:
‚Ä¢ Service is back online and operational
‚Ä¢ Monitoring will continue as normal
‚Ä¢ Review logs to identify root cause if needed"
                    ;;
                "PENDING")
                    EMOJI="‚ö†Ô∏è"
                    PRIORITY="normal"
                    ACTION="STATUS PENDING"
                    COLOR="#FFA500"
                    ALERT_TYPE="‚è≥ PENDING STATUS ALERT"
                    RECOMMENDATION="
üìù NOTES:
‚Ä¢ Service status is being evaluated
‚Ä¢ This may indicate initialization or restart
‚Ä¢ Monitor will update status shortly"
                    ;;
                *)
                    EMOJI="‚ùì"
                    PRIORITY="normal"
                    ACTION="UNKNOWN STATUS"
                    COLOR="#808080"
                    ALERT_TYPE="‚ùì STATUS UNKNOWN"
                    RECOMMENDATION="
üîç INVESTIGATION NEEDED:
‚Ä¢ Manual verification required
‚Ä¢ Check Uptime Kuma dashboard
‚Ä¢ Verify monitoring configuration"
                    ;;
            esac
            
            # Create detailed alert message
            ALERT_SUBJECT="$EMOJI Thermalog: $name $ACTION"
            ALERT_MESSAGE="$ALERT_TYPE

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üñ•Ô∏è  Monitor: $name
üìä Status Change: $PREV_STATUS ‚Üí $status
‚è∞ Timestamp: $(date '+%Y-%m-%d %H:%M:%S %Z')
üí¨ Monitor Message: ${msg:-'OK'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã MONITOR INFORMATION:
‚Ä¢ Monitor ID: $id
‚Ä¢ Monitor Type: $type
‚Ä¢ Previous Status: $PREV_STATUS
‚Ä¢ Current Status: $status
‚Ä¢ Detection Time: $time

$SYSTEM_STATUS

$RECOMMENDATION

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Uptime Kuma Dashboard: http://$(curl -s ipinfo.io/ip 2>/dev/null):3002
üåê Production Site: https://dashboard.thermalog.com.au
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Generated by Thermalog Monitoring System
Server: $(hostname)
"

            # Send email using existing system
            send_email "$ALERT_SUBJECT" "$ALERT_MESSAGE" "$PRIORITY"
            
            log_alert "$EMOJI Monitor '$name' changed: $PREV_STATUS ‚Üí $status"
            
            # Log to monitoring history
            echo "$(date '+%Y-%m-%d %H:%M:%S'),${name},${PREV_STATUS},${status},${msg}" >> /root/monitoring-history.csv
        fi
    done <<< "$CURRENT_STATUS"
    
    # Update state file
    mv "${STATE_FILE}.new" "$STATE_FILE"
else
    # No changes - clean up
    rm -f "${STATE_FILE}.new"
fi

log_alert "‚úÖ Monitor check completed"